{% load static %}
<!DOCTYPE html>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<head>
  <title>Feedback Dashboard</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.datatables.net/2.3.2/js/dataTables.js"></script>
  <link rel="stylesheet" href="{% static 'feedbackapp/dashboard.css' %}">
  <link rel="stylesheet" href="https://cdn.datatables.net/2.3.2/css/dataTables.dataTables.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body class="container text-center">

<header>
  <img src="{% static 'images/persis_logo.png' %}" alt="Persis Biryani Logo" class="logo">
  <form method="POST" action="{% url 'logout' %}">
  {% csrf_token %}
  <button type="submit">Logout</button>
</form>
</header>

<h2>Feedback Reports</h2>

<div class="summary-cards">
  <div class="card">
    <h3>Total Reviews</h3>
    <p>{{ total_reviews }}</p>
  </div>
  <div class="card">
    <h3>Average Overall Ratings</h3>
    <p>{{ avg_rating }}</p>
  </div>
  <div class="card">
    <h3>Recommendation Rate</h3>
    <p>{{ recommendation_rate }}%</p>
  </div>
</div>

<div class="container text-center">
  <div class="row">
    <div class="col">
      <h3>Average Ratings</h3>
      <canvas id="ratingsChart"></canvas>
    </div>
    <div class="col">
      <h3>Overall Feedback</h3>
      <canvas id="ratingCountChart"></canvas>
    </div>
  </div>
</div>

<h3>Monthly Reviews</h3>
<table id="reviewTable">
  <thead>
      <tr>
        <th>Name</th>
        <th>Date</th>
        <th>Food</th>
        <th>Cleanliness</th>
        <th>Service</th>
        <th>Ambience</th>
        <th>Overall</th>
        <th>Recommend?</th>
      </tr>
  </thead>
  <tbody>
    {% for review in recent_feedbacks %}
    <tr class="feedback-row" data-bs-toggle="modal" data-bs-target="#feedback{{ review.feedback_id }}">
      <td>{{ review.name }}</td>
      <td>{{ review.visit_date }}</td>
      <td>{{ review.food_rating }}</td>
      <td>{{ review.cleanliness_rating }}</td>
      <td>{{ review.service_rating }}</td>
      <td>{{ review.ambience_rating }}</td>
      <td>{{ review.overall_rating }}</td>
      <td>{{ review.recommendation }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% for review in recent_feedbacks %}
<div class="modal fade" id="feedback{{ review.feedback_id }}" tabindex="-1" aria-labelledby="dataModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="feedbackModalLabel{{ review.id }}"> 
          {{review.name}}
          {% if review.name %}
            {{ review.name }}'s Review
          {% else %}
            Anonymous's Review
          {% endif %}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <h5>Ratings</h5>
          <div>
            <p class="lead"><strong>Overall:</strong>
              {% for i in "12345" %}
                {% if forloop.counter <= review.overall_rating %}
                  ★
                {% else %}
                  ☆
                {% endif %}
              {% endfor %}
            </p>
          </div>
          <div>
            <p><strong>Food:</strong>
              {% for i in "12345" %}
                {% if forloop.counter <= review.food_rating %}
                  ★
                {% else %}
                  ☆
                {% endif %}
              {% endfor %}
            </p>
          </div>
          <div>
            <p><strong>Cleanliness:</strong>
              {% for i in "12345" %}
                {% if forloop.counter <= review.cleanliness_rating %}
                  ★
                {% else %}
                  ☆
                {% endif %}
              {% endfor %}
            </p>
          </div>
          <div>
            <p><strong>Ambience:</strong>
              {% for i in "12345" %}
                {% if forloop.counter <= review.ambience_rating %}
                  ★
                {% else %}
                  ☆
                {% endif %}
              {% endfor %}
            </p>
          </div>
          <div>
              <p><strong>Service:</strong>
              {% for i in "12345" %}
                {% if forloop.counter <= review.service_rating %}
                  ★
                {% else %}
                  ☆
                {% endif %}
              {% endfor %}
              </p>
          </div>
          {% if review.comment %}
              <hr>
              <h5>Comment:</h5>
              <p>{{ review.comment|linebreaksbr }}</p>
          {% endif %}

          {% if review.suggestions %}
            <hr>
            <h5>Suggestions:</h5>
            <p>{{ review.suggestions|linebreaksbr }}</p>
          {% endif %}

          <hr>
          <p>
            {% if review.recommendation == "Yes" %}
              <strong class="text-success">Would Recommend</strong>
            {% else %}
              <strong class="text-danger">Would NOT Recommend</strong>
            {% endif %}
          </p>
      </div>
    </div>
  </div>
</div>
{% endfor %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script>
  const chartData = {{ chart_data_json|safe }};
  const ctx = document.getElementById('ratingsChart').getContext('2d');
  new Chart(ctx, {
      type: 'bar',
      data: {
          labels: chartData.labels,
          datasets: chartData.datasets
      },
      options: {
          responsive: true,
          scales: {
              y: {
                  beginAtZero: true,
                  max: 5
              }
          }
      }
  });
  new DataTable('#reviewTable');
</script>
</body>
</html>
